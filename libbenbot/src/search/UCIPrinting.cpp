/*
 * ======================================================================================
 *
 * ░▒▓███████▓▒░░▒▓████████▓▒░▒▓███████▓▒░       ░▒▓███████▓▒░ ░▒▓██████▓▒░▒▓████████▓▒░
 * ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░
 * ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░
 * ░▒▓███████▓▒░░▒▓██████▓▒░ ░▒▓█▓▒░░▒▓█▓▒░      ░▒▓███████▓▒░░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░
 * ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░
 * ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░
 * ░▒▓███████▓▒░░▒▓████████▓▒░▒▓█▓▒░░▒▓█▓▒░      ░▒▓███████▓▒░ ░▒▓██████▓▒░  ░▒▓█▓▒░
 *
 * ======================================================================================
 */

#include <format>
#include <libbenbot/search/Search.hpp>
#include <libchess/notation/UCI.hpp>
#include <print>
#include <string>

namespace chess::search {

namespace {

    [[nodiscard]] std::string get_score_string(const int score)
    {
        if (! detail::is_mate_score(score))
            return std::format("cp {}", score);

        auto plyToMate = detail::ply_to_mate_from_score(score);

        if (plyToMate > 0uz)
            ++plyToMate;

        // plies -> moves
        const auto mateIn = plyToMate / 2uz;

        auto mateVal = static_cast<int>(mateIn);

        if (score < 0)
            mateVal *= -1;

        return std::format("mate {}", mateVal);
    }

    template <bool PrintBestMove>
    void print_uci_info(const Callbacks::Result& res)
    {
        std::println(
            "info depth {} score {} time {}",
            res.depth, get_score_string(res.score), res.duration.count());

        if constexpr (PrintBestMove) {
            std::println("bestmove {}", notation::to_uci(res.bestMove));
        }
    }

} // namespace

Callbacks Callbacks::make_uci_handler()
{
    return {
        .onSearchComplete = [](const Result& res) { print_uci_info<true>(res); },
        .onIteration = [](const Result& res) { print_uci_info<false>(res); },
    };
}

} // namespace chess::search
